<!DOCTYPE html>
<html>
<head>
  <title>TechWeekend Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://bpgc-cte.org/logo.png" type="image/png">
</head>
<body class="bg-gray-900 min-h-screen p-8 font-sans text-white">
  <h1 class="text-3xl font-bold mb-6">TechWeekend Admin Dashboard</h1>

  <div class="flex items-center gap-4 mb-6">
    <a href="/tech-weekend" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">
      Back to User Dashboard
    </a>

    <a id="downloadBtn" href="/admin/techweekend/registrations/download" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
      Download All Registrations (CSV)
    </a>

    <label for="eventSelect" class="font-medium">Filter by Event:</label>
    <select id="eventSelect" class="border border-gray-600 bg-gray-800 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="">-- All Events --</option>
      <% events.forEach(e => { %>
        <option value="<%= e.id %>"><%= e.name %></option>
      <% }) %>
    </select>
  </div>

  <div class="flex flex-wrap gap-4 mb-6">
    <div class="inline-flex items-center gap-3 bg-green-900 border border-green-700 text-green-300 px-4 py-2 rounded-lg shadow-sm">
      <span class="font-semibold" id="registrationCountText">
        Total People: <%= registrations.length %>
      </span>
    </div>

    <div class="inline-flex items-center gap-3 bg-blue-900 border border-blue-700 text-blue-300 px-4 py-2 rounded-lg shadow-sm">
      <span class="font-semibold" id="eventEnrollmentText">
        Total Event Enrollments: <%= registrations.reduce((sum, r) => sum + r.total_events, 0) %>
      </span>
    </div>
  </div>

  <h2 class="text-xl font-semibold mb-4">Registrations (Grouped by User)</h2>
  <div class="overflow-x-auto">
    <table id="registrationsTable" class="min-w-full border border-green-600 rounded shadow-sm bg-black">
      <thead class="bg-green-700">
        <tr>
          <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Email</th>
          <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Display Name</th>
          <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Events Registered</th>
          <th class="px-4 py-2 text-left font-bold text-white">Total Events</th>
        </tr>
      </thead>
      <tbody>
        <% registrations.forEach((r, idx) => { %>
          <tr data-event-ids="<%= r.event_ids.join(',') %>" data-total-events="<%= r.total_events %>" class="<%= idx % 2 === 0 ? 'bg-gray-900' : 'bg-gray-800' %> hover:bg-green-950 border-b border-green-600">
            <td class="px-4 py-2 text-green-300 border-r border-green-600"><%= r.email %></td>
            <td class="px-4 py-2 text-green-300 border-r border-green-600"><%= r.display_name %></td>
            <td class="px-4 py-2 text-green-300 border-r border-green-600"><%= r.events_registered %></td>
            <td class="px-4 py-2 text-green-300"><%= r.total_events %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <div id="noResults" class="hidden mt-4 text-gray-400 italic">
    No registrations found for this event.
  </div>

  <script>
    const eventSelect = document.getElementById('eventSelect');
    const downloadBtn = document.getElementById('downloadBtn');
    const tableRows = document.querySelectorAll('#registrationsTable tbody tr');
    const noResults = document.getElementById('noResults');
    const registrationCountText = document.getElementById('registrationCountText');
    const eventEnrollmentText = document.getElementById('eventEnrollmentText');

    eventSelect.addEventListener('change', () => {
      const selectedEventId = eventSelect.value;
      let visibleCount = 0;

      if (selectedEventId) {
        downloadBtn.href = `/admin/techweekend/registrations/${selectedEventId}/download`;
        downloadBtn.textContent = 'Download This Event (CSV)';
      } else {
        downloadBtn.href = `/admin/techweekend/registrations/download`;
        downloadBtn.textContent = 'Download All Registrations (CSV)';
      }

      tableRows.forEach(row => {
        const eventIds = row.getAttribute('data-event-ids').split(',');
        const match = !selectedEventId || eventIds.includes(selectedEventId);
        row.style.display = match ? '' : 'none';
        if (match) visibleCount++;
      });

      registrationCountText.textContent = selectedEventId
        ? `Total Registrations for this event: ${visibleCount}`
        : `Total Registrations (all events): ${visibleCount}`;

      eventEnrollmentText.textContent = selectedEventId
        ? `Total Event Enrollments for this event: ${visibleCount}`
        : `Total Event Enrollments (all events): ${[...tableRows].reduce((sum, row) => {
            return sum + parseInt(row.getAttribute('data-total-events'), 10);
          }, 0)}`;

      noResults.classList.toggle('hidden', visibleCount !== 0);
    });
  </script>

</body>
</html>
