<!DOCTYPE html>
<html>

<head>
  <title>TechWeekend Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://bpgc-cte.org/logo.png" type="image/png">
</head>

<body class="bg-gray-900 min-h-screen p-8 font-sans text-white">
  <h1 class="text-3xl font-bold mb-6 text-center">TechWeekend Admin Dashboard</h1>

  <!-- Toggle Buttons -->
  <div class="flex justify-center gap-6 mb-6">
    <button onclick="toggleSection('registrationsSection', 'registrationsArrow')"
      class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-600 flex items-center gap-2">
      <span id="registrationsArrow">+</span> Registrations
    </button>
    <button onclick="toggleSection('eventsSection', 'eventsArrow')"
      class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600 flex items-center gap-2">
      <span id="eventsArrow">+</span> Manage Events
    </button>
    <a href="/tech-weekend" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">
      Back to User Dashboard
    </a>
  </div>

  <!-- Registrations Section -->
  <div id="registrationsSection" class="hidden tab-content">
    <div class="flex items-center gap-4 mb-6">

      <a id="downloadBtn" href="/admin/techweekend/registrations/download"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
        Download All Registrations (CSV)
      </a>

      <label for="eventSelect" class="font-medium">Filter by Event:</label>
      <select id="eventSelect"
        class="border border-gray-600 bg-gray-800 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">-- All Events --</option>
        <% events.forEach(e=> { %>
          <option value="<%= e.id %>">
            <%= e.name %>
          </option>
          <% }) %>
      </select>
    </div>

    <div class="flex flex-wrap gap-4 mb-6">
      <div
        class="inline-flex items-center gap-3 bg-green-900 border border-green-700 text-green-300 px-4 py-2 rounded-lg shadow-sm">
        <span class="font-semibold" id="registrationCountText">
          Total People: <%= registrations.length %>
        </span>
      </div>

      <div
        class="inline-flex items-center gap-3 bg-blue-900 border border-blue-700 text-blue-300 px-4 py-2 rounded-lg shadow-sm">
        <span class="font-semibold" id="eventEnrollmentText">
          Total Event Enrollments: <%= registrations.reduce((sum, r)=> sum + r.total_events, 0) %>
        </span>
      </div>
    </div>

    <h2 class="text-xl font-semibold mb-4">Registrations (Grouped by User)</h2>
    <div class="overflow-x-auto">
      <table id="registrationsTable" class="min-w-full border border-green-600 rounded shadow-sm bg-black">
        <thead class="bg-green-700">
          <tr>
            <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Email</th>
            <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Display Name</th>
            <th class="px-4 py-2 text-left font-bold text-white border-r border-green-600">Events Registered</th>
            <th class="px-4 py-2 text-left font-bold text-white">Total Events</th>
          </tr>
        </thead>
        <tbody>
          <% registrations.forEach((r, idx)=> { %>
            <tr data-event-ids="<%= r.event_ids.join(',') %>" data-total-events="<%= r.total_events %>"
              class="<%= idx % 2 === 0 ? 'bg-gray-900' : 'bg-gray-800' %> hover:bg-green-950 border-b border-green-600">
              <td class="px-4 py-2 text-green-300 border-r border-green-600">
                <%= r.email %>
              </td>
              <td class="px-4 py-2 text-green-300 border-r border-green-600">
                <%= r.display_name %>
              </td>
              <td class="px-4 py-2 text-green-300 border-r border-green-600">
                <%= r.events_registered %>
              </td>
              <td class="px-4 py-2 text-green-300">
                <%= r.total_events %>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>

    <div id="noResults" class="hidden mt-4 text-gray-400 italic">
      No registrations found for this event.
    </div>
  </div>

  <!-- Events Section -->
  <div id="eventsSection" class="hidden tab-content">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold">Manage TechWeekend Events</h2>
      <button onclick="document.getElementById('addEventForm').classList.toggle('hidden')"
        class="px-4 py-2 bg-green-600 rounded hover:bg-green-500">
        Add New Event
      </button>
    </div>

    <!-- Add Event Form -->
    <form id="addEventForm" action="/admin/techweekend/events/add" method="POST"
      class="hidden mb-6 bg-gray-800 p-4 rounded">
      <h3 class="text-lg font-bold mb-2">Add Event</h3>
      <input type="text" name="name" placeholder="Event Name"
        class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white" required>
      <input type="text" name="poster_url" placeholder="Poster URL"
        class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white" required>
      <textarea name="event_description" placeholder="Event Description"
        class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white" required></textarea>
      <button type="submit" class="px-4 py-2 bg-green-600 rounded hover:bg-green-500">Add Event</button>
    </form>

    <!-- Event Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <% events.forEach(e=> { %>
        <div class="bg-gray-800 rounded-lg shadow-md p-4 flex flex-col justify-between">
          <div>
            <img src="<%= e.poster_url %>" alt="Poster" class="w-full h-40 object-cover rounded mb-3">
            <h3 class="text-lg font-bold mb-2">
              <%= e.name %>
            </h3>
            <p class="text-gray-300 mb-4">
              <%= e.event_description %>
            </p>
          </div>
          <div class="flex flex-wrap gap-2 mt-auto">
            <form action="/admin/techweekend/events/delete/<%= e.id %>" method="POST"
              onsubmit="return confirm('Delete this event?');">
              <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-500">Delete</button>
            </form>
            <button onclick="toggleEditForm('<%= e.id %>')"
              class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-500">Edit</button>
          </div>

          <!-- Inline Edit Form -->
          <form id="editForm-<%= e.id %>" action="/admin/techweekend/events/edit/<%= e.id %>" method="POST"
            class="hidden mt-4">
            <input type="text" name="name" value="<%= e.name %>"
              class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white" required>
            <input type="text" name="poster_url" value="<%= e.poster_url %>"
              class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white" required>
            <textarea name="event_description" class="w-full mb-2 px-3 py-2 rounded bg-gray-700 text-white"
              required><%= e.event_description %></textarea>
            <button type="submit" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">Save Changes</button>
          </form>
        </div>
        <% }) %>
    </div>
  </div>
  <script>
    // Toggle sections with + / - arrows
    function toggleSection(sectionId, arrowId) {
      const section = document.getElementById(sectionId);
      const arrow = document.getElementById(arrowId);
      const isVisible = !section.classList.contains('hidden');

      // Hide all sections
      document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
      document.querySelectorAll('[id$="Arrow"]').forEach(a => a.textContent = '+');

      // Toggle selected section
      if (!isVisible) {
        section.classList.remove('hidden');
        arrow.textContent = '-';
      }
    }

    // Toggle inline edit form for events
    function toggleEditForm(id) {
      const form = document.getElementById(`editForm-${id}`);
      form.classList.toggle('hidden');
    }

    // Event filter + CSV download logic
    const eventSelect = document.getElementById('eventSelect');
    const downloadBtn = document.getElementById('downloadBtn');
    const tableRows = document.querySelectorAll('#registrationsTable tbody tr');
    const noResults = document.getElementById('noResults');
    const registrationCountText = document.getElementById('registrationCountText');
    const eventEnrollmentText = document.getElementById('eventEnrollmentText');

    if (eventSelect) {
      eventSelect.addEventListener('change', () => {
        const selectedEventId = eventSelect.value;
        let visibleCount = 0;

        if (selectedEventId) {
          downloadBtn.href = `/admin/techweekend/registrations/${selectedEventId}/download`;
          downloadBtn.textContent = 'Download This Event (CSV)';
        } else {
          downloadBtn.href = `/admin/techweekend/registrations/download`;
          downloadBtn.textContent = 'Download All Registrations (CSV)';
        }

        tableRows.forEach(row => {
          const eventIds = row.getAttribute('data-event-ids').split(',');
          const match = !selectedEventId || eventIds.includes(selectedEventId);
          row.style.display = match ? '' : 'none';
          if (match) visibleCount++;
        });

        registrationCountText.textContent = selectedEventId
          ? `Total Registrations for this event: ${visibleCount}`
          : `Total Registrations (all events): ${visibleCount}`;

        eventEnrollmentText.textContent = selectedEventId
          ? `Total Event Enrollments for this event: ${visibleCount}`
          : `Total Event Enrollments (all events): ${[...tableRows].reduce((sum, row) => {
            return sum + parseInt(row.getAttribute('data-total-events'), 10);
          }, 0)}`;

        noResults.classList.toggle('hidden', visibleCount !== 0);
      });
    }
  </script>
</body>

</html>